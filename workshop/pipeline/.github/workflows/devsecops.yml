# ===========================================
# Pipeline GitHub Actions DevSecOps
# ===========================================

name: DevSecOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '11'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================
  # BUILD & TEST
  # ===========================================
  build:
    name: Build & Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean compile -DskipTests
        working-directory: ./vulnerable-app

      - name: Run Unit Tests
        run: mvn test
        working-directory: ./vulnerable-app

      - name: Generate JaCoCo Report
        run: mvn jacoco:report
        working-directory: ./vulnerable-app

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: vulnerable-app/target/*.jar

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: vulnerable-app/target/surefire-reports/

  # ===========================================
  # ANALYSE DES DÉPENDANCES (SCA)
  # ===========================================
  dependency-check:
    name: OWASP Dependency-Check
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'VulnerableBank'
          path: './vulnerable-app'
          format: 'HTML,JSON,XML'
          out: 'dependency-check-report'
          args: >
            --failOnCVSS 7
            --enableExperimental

      - name: Upload Dependency-Check Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: dependency-check-report/

  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Generate CycloneDX SBOM
        run: mvn org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom
        working-directory: ./vulnerable-app

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            vulnerable-app/target/bom.xml
            vulnerable-app/target/bom.json

  trivy-scan:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './vulnerable-app'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ===========================================
  # ANALYSE STATIQUE (SAST)
  # ===========================================
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build for SonarQube
        run: mvn clean verify -DskipTests
        working-directory: ./vulnerable-app

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: ./vulnerable-app

  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan --config=auto \
            --config=p/java \
            --config=p/owasp-top-ten \
            --config=p/security-audit \
            --sarif --output=semgrep.sarif \
            --json --output=semgrep.json \
            vulnerable-app/src/

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif

      - name: Upload Semgrep Report
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: |
            semgrep.sarif
            semgrep.json

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          queries: security-extended

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build
        run: mvn clean compile -DskipTests
        working-directory: ./vulnerable-app

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  spotbugs:
    name: SpotBugs + Find Security Bugs
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Run SpotBugs with Security Plugin
        run: |
          mvn spotbugs:check \
            -Dspotbugs.plugins.plugin.groupId=com.h3xstream.findsecbugs \
            -Dspotbugs.plugins.plugin.artifactId=findsecbugs-plugin \
            -Dspotbugs.plugins.plugin.version=1.12.0
        working-directory: ./vulnerable-app
        continue-on-error: true

      - name: Upload SpotBugs Report
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-report
          path: vulnerable-app/target/spotbugsXml.xml
        if: always()

  # ===========================================
  # BUILD DOCKER IMAGE
  # ===========================================
  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [build, dependency-check, semgrep]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./vulnerable-app
          push: false
          tags: vulnerable-bank:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: vulnerable-bank:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-docker.sarif'

      - name: Upload Docker scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-docker.sarif'

  # ===========================================
  # ANALYSE DYNAMIQUE (DAST)
  # ===========================================
  dast-zap:
    name: OWASP ZAP DAST
    runs-on: ubuntu-latest
    needs: docker-build
    services:
      vulnerable-app:
        image: vulnerable-bank:${{ github.sha }}
        ports:
          - 8080:8080
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for application
        run: |
          echo "Waiting for application to start..."
          sleep 30
          curl -f http://localhost:8080/api/health || exit 1

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-I'

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: report_html.html

  # ===========================================
  # RAPPORT CONSOLIDÉ
  # ===========================================
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [dependency-check, sbom-generation, trivy-scan, semgrep, spotbugs, dast-zap]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate Security Summary
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "## Scan Results" >> security-summary.md
          echo "- Dependency Check: ✅ Completed" >> security-summary.md
          echo "- SBOM Generation: ✅ Completed" >> security-summary.md
          echo "- Trivy Scan: ✅ Completed" >> security-summary.md
          echo "- Semgrep SAST: ✅ Completed" >> security-summary.md
          echo "- SpotBugs: ✅ Completed" >> security-summary.md
          echo "- ZAP DAST: ✅ Completed" >> security-summary.md

      - name: Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
